# 系统当前架构与流程梳理

## 1. 系统目标与边界
- 目标：根据用户输入的软著信息，自动生成三类交付物：`源程序文档`、`操作手册`、`申请表`，并提供在线进度追踪与下载。
- 架构形态：前后端分离。
- 前端：`Vue3 + Vite + Pinia + Element Plus`。
- 后端：`Flask` 提供 REST API 与 SSE，`ThreadPoolExecutor` 承载异步任务，文件系统作为任务与产物存储。

## 2. 总体架构（分层）
1. 展示层（`client/src`）
- 表单采集项目参数，发起任务。
- 通过 SSE/轮询展示进度、日志、告警。
- 任务完成后提供单文件与 ZIP 下载入口。

2. 接口层（`server/api`）
- `POST /api/generate`：创建任务。
- `GET /api/task/<task_id>`：查询任务状态。
- `GET /api/task/<task_id>/stream`：SSE 推送进度。
- `POST /api/task/<task_id>/cancel`：取消任务。
- `GET /api/download/<task_id>/<doc_type>`、`GET /api/download/<task_id>/all`：下载文档/ZIP。

3. 编排与任务层（`server/task` + `server/generators/orchestrator.py`）
- `TaskManager` 负责任务提交、状态持久化、日志与告警记录、线程池调度。
- `Orchestrator` 负责六步流水线编排、检查点保存与恢复、错误分级处理。

4. 生成能力层（`server/generators`）
- 功能清单生成、代码生成、HTML 生成、截图生成、文档生成、一致性校验。
- 生成中间产物落盘到 `server/output/<task_id>/work/*`。

5. AI 与配置层（`server/ai` + `server/tech_stacks` + `server/config.py`）
- AI 通过适配器模式支持 `tongyi` / `zhipu`，主备切换与重试。
- 技术栈从 YAML 读取，驱动前端下拉与文档字段填充。

## 3. 后端核心模块职责
- `server/app.py`：初始化 Flask、CORS、蓝图注册、全局 `task_manager`、运行目录创建。
- `server/task/task_manager.py`：
  - 任务状态字段：`status/current_step/progress/message/warnings/errors/logs/output_files/context`。
  - 状态持久化：`server/data/tasks/<task_id>.json`。
  - 恢复机制：启动时加载 JSON，将 `processing` 置为 `interrupted`。
- `server/generators/orchestrator.py`：
  - 六步执行、逐步更新进度、写 checkpoint：`server/data/tasks/checkpoints/*_checkpoint.json`。
  - 错误模型：
    - `StepFatalError`：终止任务并标记 failed。
    - `StepWarningError`：记录 warning，允许后续步骤继续。

## 4. 六步流水线（真实执行顺序）
1. 生成功能清单（`FeatureGenerator`）
- 优先调用 AI 输出 6 个功能模块（含 `page_type`、`operation_steps`）。
- AI 失败时降级为默认 6 功能模板（登录、首页、列表、录入、详情、统计）。

2. 生成源代码（`CodeGenerator`）
- 生成基础骨架文件 + 每功能后端/前端文件。
- 若总代码行数不足目标 60%，自动补充 `docs/implementation_notes/part_*.md`。
- 统计行数写入 `context.total_lines`。

3. 生成 HTML 页面（`HtmlPageGenerator`）
- 按功能输出静态 HTML 到 `server/output/<task_id>/work/html/`。

4. 页面截图（`ScreenshotService`）
- 优先 Playwright 截图。
- 失败时降级为占位图（PIL 或文本占位），保证流程可继续。

5. 生成文档（3 个生成器）
- 执行一致性校验（代码映射、截图存在性、行数阈值）。
- 生成：
  - `*_源程序.docx`
  - `*_操作手册.docx`
  - `*_申请表.docx`
- `python-docx` 缺失时分别降级为 `.txt`。

6. 打包下载
- 校验 `output_files` 后标记任务完成。
- 下载接口支持单文件和内存 ZIP 聚合下载。

## 5. 前端流程（用户视角）
1. `HomeView` + `ProjectForm`
- 加载技术栈列表：`GET /api/tech-stacks`，失败时使用本地默认选项。
- 提交生成参数：`software_name/description/tech_stack/target_lines/completion_date`。

2. `ProgressView`
- 建立 SSE：`/api/task/<task_id>/stream`。
- SSE 中断则自动切换 2 秒轮询：`GET /api/task/<task_id>`。
- 支持取消任务：`POST /api/task/<task_id>/cancel`。

3. `ResultView`
- 展示 warning。
- 文档卡片按 `output_files` 启用下载。
- 支持一键 ZIP 下载：`GET /api/download/<task_id>/all`。

## 6. 关键数据与存储路径
- 任务状态：`server/data/tasks/<task_id>.json`
- 检查点：`server/data/tasks/checkpoints/<task_id>_checkpoint.json`
- 中间代码：`server/output/<task_id>/work/code/*`
- 中间 HTML：`server/output/<task_id>/work/html/*`
- 截图：`server/screenshots/<task_id>/*`
- 交付文档：`server/output/<task_id>/*_源程序.docx|*_操作手册.docx|*_申请表.docx`

## 7. 当前流程中的降级与韧性设计
- AI 生成功能清单失败 -> 默认功能清单兜底。
- 截图失败 -> 占位图兜底。
- 文档库缺失 -> TXT 文档兜底。
- SSE 异常 -> 前端轮询兜底。
- 服务重启 -> 任务状态可从 JSON 恢复（处理中任务标记为中断）。

## 8. 当前架构特征总结
- 优点：
  - 模块边界清晰，编排器将流程串联，便于后续扩展步骤。
  - 关键节点具备降级策略，流程“可完成性”较高。
  - 前端具备 SSE + 轮询双通道，实时性与可用性平衡。
- 现状约束：
  - 任务存储与状态依赖本地文件系统，适合单机/轻量场景。
  - 取消任务依赖 `Future.cancel()`，已运行任务通常无法立即中断。
  - 代码生成当前为模板+扩充策略，业务真实度仍偏 MVP。
