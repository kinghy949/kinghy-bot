# 软著材料生成系统开发计划 v2.0

## 背景与目标

开发一个基于Web的软著材料自动生成系统，用户输入软著名称和项目描述后，系统自动生成符合中国版权保护中心标准格式的：
1. 源代码文档（包含格式化的代码、行号、页眉页脚）
2. 操作手册（包含目录、自动生成的真实页面截图、模板化内容）
3. 申请表（辅助用户填写软著申请，基于Word模板自动填充）

三份文档均为Word格式（.docx），可直接用于软著申请。

### v2.0 相比 v1.0 的核心变化

| 变更项 | v1.0 | v2.0 |
|--------|------|------|
| 系统前端 | HTML + Bootstrap | Vue3 + Vite + Element Plus |
| 操作手册截图 | 用户手动上传 | 系统自动生成HTML页面并截图 |
| 输出文档数量 | 2个（源码+使用说明） | 3个（源码+操作手册+申请表） |
| 一致性保证 | 无 | feature_list 单一事实来源机制 |
| 生成代码技术栈 | 固定 | 用户可选（SpringBoot/Vue/Flask等） |
| 进度推送 | 轮询 | SSE (Server-Sent Events) |
| 架构 | 单体 | 前后端分离 |

## 技术栈

- **后端框架**: Flask (Python) + Flask-CORS + Flask-RESTful
- **前端框架**: Vue3 + Vite + Vue Router + Pinia + Element Plus + Axios
- **Word文档处理**: python-docx
- **AI集成**: 国产大模型供应商（如：文心一言、通义千问、智谱AI等，可配置）
- **HTML页面生成**: Jinja2 模板引擎
- **页面截图**: Playwright (Python版，无头Chromium)
- **代码格式化**: Pygments (语法高亮)
- **异步处理**: Celery + Redis（处理AI生成的长时间任务）
- **进度推送**: SSE (Server-Sent Events)
- **文件存储**: 本地文件系统

## 核心功能模块

### 1. Web界面模块（Vue3 SPA）

前后端分离架构，Vue3作为系统本身的前端框架。

#### 1.1 首页 - 输入表单（HomeView.vue）

- 用户输入表单：
  - 软著名称（必填）
  - 项目简单描述（一句话，必填）
  - 项目类型选择（Web应用/桌面应用/移动应用/API服务）
  - 技术栈选择（根据项目类型动态显示可选项）
    - Web应用：SpringBoot+Vue / SpringBoot+React / Flask+Vue / Django+React 等
    - 桌面应用：Electron+Vue / JavaFX / WPF+C# / Qt+Python 等
    - 移动应用：Android(Java) / Android(Kotlin) / Flutter / React Native 等
    - API服务：SpringBoot / Flask / Express / Go Gin 等
  - 目标代码行数（默认5000行，可调整）
  - 开发完成日期（用于申请表，默认当前日期）
- 表单验证（Element Plus表单校验）

#### 1.2 进度页（ProgressView.vue）

- 6步生成进度指示器（StepIndicator组件）
- 当前步骤详细进度（ProgressTracker组件）
- SSE实时日志输出
- 支持取消任务

#### 1.3 结果页（ResultView.vue）

- 3个文档卡片（DocumentCard组件）：源码文档、操作手册、申请表
- 单独下载 / 一键下载ZIP包
- 文档预览（可选）

#### 1.4 Vue3组件结构

```
src/
├── main.js                     # Vue入口
├── App.vue                     # 根组件
├── router/
│   └── index.js                # 路由：/ → /progress/:taskId → /result/:taskId
├── stores/
│   └── generate.js             # Pinia状态管理（任务状态、进度）
├── api/
│   └── index.js                # Axios封装 + API调用
├── views/
│   ├── HomeView.vue            # 首页表单
│   ├── ProgressView.vue        # 生成进度
│   └── ResultView.vue          # 结果下载
├── components/
│   ├── ProjectForm.vue         # 项目信息表单
│   ├── TechStackSelector.vue   # 技术栈选择器（联动）
│   ├── ProgressTracker.vue     # 进度追踪
│   ├── DocumentCard.vue        # 文档卡片
│   └── StepIndicator.vue       # 步骤指示器
└── assets/
    └── styles/
        └── main.scss
```

### 2. AI代码生成模块

AI根据用户选择的技术栈生成对应的软著源代码（非固定技术栈）。

- **提示词构建器** (`prompt_builder.py`)：
  - 根据项目类型、用户选择的技术栈和描述构建AI提示词
  - 包含代码行数要求
  - 指定代码结构和文件组织
  - 针对不同技术栈使用不同的提示词模板

- **AI客户端** (`ai_client.py`)：
  - 封装国产大模型API调用（文心一言/通义千问/智谱AI，可配置切换）
  - 支持流式响应（实时显示生成进度）
  - 错误重试机制
  - 多模型适配器模式

- **代码验证器** (`code_validator.py`)：
  - 验证生成的代码语法正确性
  - 统计代码行数
  - 检查代码完整性（是否有主文件、配置等）

- **代码扩展器** (`code_expander.py`)：
  - 如果代码行数不足目标行数，自动补充
  - 添加更多功能模块、注释、文档字符串
  - 生成测试文件、配置文件等

### 3. 源码文档生成模块

按照软著要求格式化源代码：
- 页面设置：A4纸张，上下边距2.54cm，左右边距3.17cm
- 页眉："{软著名称}源程序"，宋体小五号
- 页脚：页码（居中），"第X页 共Y页"
- 行号：每行代码前添加行号（右对齐，4位数字）
- 字体：代码使用Courier New 小四号
- 提取规则：前60页 + 后30页（共90页，约3000行代码）
- 如果代码不足90页，则全部输出
- **一致性要求**：源码文档中的代码必须与操作手册中展示的功能页面对应，包含前端组件代码和后端API代码

### 4. 操作手册生成模块（重点改造）

#### 4.1 v2.0 截图生成流程

v1.0：用户手动上传截图 → 插入文档
v2.0：AI生成HTML静态页面 → Playwright自动截图 → 插入文档对应章节

```
遍历 feature_list
    │
    ▼
[选择HTML模板] → login / dashboard / list / form / detail
    │
    ▼
[AI生成页面内容] → 表单字段、表格列、菜单项、示例数据
    │
    ▼
[Jinja2渲染] → 完整HTML文件（内联CSS，不依赖外部资源）
    │
    ▼
[Playwright截图] → 无头Chromium，视口1280x720，保存PNG
    │
    ▼
[插入操作手册] → python-docx插入图片到对应章节
```

#### 4.2 HTML页面生成器 (`html_page_generator.py`)

- 根据 `feature.page_type` 选择基础HTML模板
- 可用模板类型：
  - `login` - 登录/注册页面
  - `dashboard` - 仪表盘/首页
  - `list` - 数据列表页（表格+搜索+分页）
  - `form` - 表单页（新增/编辑）
  - `detail` - 详情页
  - `chart` - 图表统计页
- AI生成页面具体内容（字段名、菜单项、表格数据等）
- Jinja2渲染为完整HTML文件
- 设计原则：
  - 所有CSS内联，确保截图时样式完整
  - 统一UI风格（模拟Element Plus管理系统外观）
  - 包含侧边栏导航、顶部标题栏、内容区域
  - 表单预填充示例数据，让截图更真实

#### 4.3 截图服务 (`screenshot_service.py`)

- 使用 Playwright Python版
- 启动无头Chromium浏览器
- 打开本地HTML文件（file:// 协议）
- 视口设置：1280x720
- 等待页面渲染完成后截图
- 批量截图复用浏览器实例，提升性能
- 截图保存为PNG格式

#### 4.4 操作手册文档结构

- **封面页**：
  - 软著名称
  - 版本号（V1.0）
  - 编写日期

- **自动生成目录**（使用Word样式）

- **标准章节**：
  1. **引言**
     - 1.1 编写目的
     - 1.2 项目背景
     - 1.3 术语定义

  2. **运行环境**
     - 2.1 硬件环境
     - 2.2 软件环境（根据用户选择的技术栈自动填充）
     - 2.3 网络环境

  3. **安装与配置**
     - 3.1 安装步骤（根据项目类型和技术栈生成）
     - 3.2 配置说明
     - 3.3 启动方法

  4. **功能说明**（核心章节，遍历feature_list生成）
     - 4.1 功能概述
     - 4.2 功能模块详细说明
       - 4.2.1 {功能名称1}
         - AI生成的功能描述文字
         - **自动截图**（从HTML页面截取，非用户上传）
         - 操作步骤说明
       - 4.2.2 {功能名称2}
         - ...
       - （遍历所有feature生成）

  5. **注意事项**
     - 5.1 使用限制
     - 5.2 常见问题

- **格式规范**：标题使用黑体，正文使用宋体，行间距1.5倍
- **图片标题**：每张截图下方添加居中图注（如"图1 用户登录界面"）

### 5. 申请表生成模块（新增）

#### 5.1 生成方式

采用"基于Word模板填充"方式：
1. 读取 `template/` 目录下的申请表 .docx 模板文件
2. 使用 python-docx 定位模板中的占位字段
3. 根据用户输入和AI生成结果自动替换填充

#### 5.2 自动填充字段

| 字段 | 数据来源 |
|------|----------|
| 软件全称 | 用户输入的软著名称 |
| 简称 | 从全称自动提取 |
| 版本号 | V1.0（默认） |
| 软件分类 | 根据项目类型映射 |
| 开发完成日期 | 用户输入（默认当前日期） |
| 源程序量(行) | 从 generated_code 统计 |
| 编程语言 | 根据用户选择的技术栈映射 |
| 主要功能 | 从 feature_list 提取摘要 |
| 硬件环境 | 根据项目类型自动填充 |
| 运行环境/操作系统 | 根据项目类型映射 |
| 软件环境 | 根据技术栈映射（如"JDK 1.8, MySQL 5.7"） |
| 开发工具 | 根据技术栈映射（如"IntelliJ IDEA, VS Code"） |
| 权利取得方式 | 原始取得（默认值） |
| 权利范围 | 全部（默认值） |

#### 5.3 技术栈与环境信息映射表

```python
TECH_STACK_MAPPING = {
    "springboot_vue": {
        "languages": "Java、JavaScript、HTML、CSS",
        "dev_tools": "IntelliJ IDEA 2023、Maven 3.8、VS Code",
        "runtime": "JDK 1.8、MySQL 5.7、Apache Tomcat 9.0、Node.js 18",
        "os": "Windows 10 / CentOS 7.6"
    },
    "flask_vue": {
        "languages": "Python、JavaScript、HTML、CSS",
        "dev_tools": "VS Code、PyCharm 2023",
        "runtime": "Python 3.10、Node.js 18、MySQL 5.7、Redis 7.0",
        "os": "Windows 10 / Ubuntu 22.04"
    },
    "android_java": {
        "languages": "Java、XML",
        "dev_tools": "Android Studio 2023、Gradle 8.0",
        "runtime": "Android SDK 33、JDK 11",
        "os": "Android 10.0及以上"
    },
    # 更多技术栈映射...
}
```

### 6. 文档下载模块

- 生成三个Word文档：
  - `{软著名称}_源程序.docx`
  - `{软著名称}_操作手册.docx`
  - `{软著名称}_申请表.docx`
- 打包为ZIP文件供用户下载
- 支持单独下载每个文档

## 生成编排器与一致性保证

### 7. 生成编排器 (`orchestrator.py`)

编排器是v2.0的核心协调模块，维护 `ProjectContext` 数据结构，贯穿整个生成流程，确保三文档一致性。

#### 7.1 ProjectContext 数据结构

```python
class Feature:
    """功能模块描述，一致性的最小单元"""
    name: str               # 功能名称（如"用户登录"）
    description: str        # 功能描述
    page_type: str          # 页面类型（login/dashboard/list/form/detail/chart）
    manual_section: str     # 对应操作手册章节编号（如"4.2.1"）
    code_files: list[str]   # 对应的源代码文件列表（生成后填充）
    html_path: str          # HTML页面路径（生成后填充）
    screenshot_path: str    # 截图文件路径（生成后填充）
    operation_steps: str    # 操作步骤说明（AI生成）

class ProjectContext:
    """贯穿整个生成流程的上下文对象"""

    # 用户输入
    software_name: str          # 软著名称
    description: str            # 项目描述
    project_type: str           # 项目类型
    tech_stack: dict            # 用户选择的技术栈
    target_lines: int           # 目标代码行数
    completion_date: str        # 开发完成日期

    # AI生成的功能清单（一致性的核心锚点）
    feature_list: list[Feature]

    # 生成产物
    generated_code: dict        # {文件路径: 代码内容}
    generated_html_pages: dict  # {功能名: HTML文件路径}
    screenshots: dict           # {功能名: 截图文件路径}

    # 统计信息（用于申请表）
    total_lines: int            # 源程序量
    languages: list[str]        # 编程语言列表
```

#### 7.2 六步生成流程

```
用户输入 → [步骤1] AI生成功能清单
              │
              ▼
         [步骤2] AI生成源代码（按feature_list逐功能生成）
              │
              ▼
         [步骤3] 生成HTML静态页面（按feature_list遍历）
              │
              ▼
         [步骤4] Playwright批量截图
              │
              ▼
         [步骤5] 并行生成3个Word文档
              │    ├→ 源码文档 ← generated_code
              │    ├→ 操作手册 ← feature_list + screenshots
              │    └→ 申请表   ← 模板填充
              ▼
         [步骤6] 打包ZIP → 返回下载链接
```

各步骤详细说明：

| 步骤 | 名称 | 输入 | 输出 | 预估耗时 |
|------|------|------|------|----------|
| 1 | 生成功能清单 | 软著名称+描述+类型+技术栈 | feature_list (5-10个功能) | 10-20秒 |
| 2 | 生成源代码 | feature_list + 技术栈 | generated_code | 2-5分钟 |
| 3 | 生成HTML页面 | feature_list + 页面模板 | HTML文件 | 30-60秒 |
| 4 | 页面截图 | HTML文件列表 | PNG截图 | 10-30秒 |
| 5 | 生成文档 | 所有产物 | 3个.docx文件 | 20-40秒 |
| 6 | 打包下载 | 3个.docx | ZIP文件 | <5秒 |

### 8. 三文档一致性保证机制

`feature_list` 作为"单一事实来源"（Single Source of Truth），三个文档都从同一个 feature_list 派生内容：

```
                    ┌─────────────────┐
                    │  feature_list   │  ← 步骤1确定，后续不可变
                    │  (功能清单)      │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
     ┌────────────┐  ┌────────────┐  ┌────────────┐
     │  源码文档   │  │  操作手册   │  │  申请表     │
     │            │  │            │  │            │
     │ 包含每个    │  │ 每个功能有  │  │ 主要功能   │
     │ 功能的前后  │  │ 描述+截图+  │  │ 描述来自   │
     │ 端代码     │  │ 操作步骤    │  │ feature    │
     └────────────┘  └────────────┘  └────────────┘
```

一致性示例：

```
Feature: "用户登录"
  │
  ├→ 源码文档包含:
  │     - LoginView.vue（前端登录组件）
  │     - auth.js（前端API调用）
  │     - auth_controller.py（后端登录接口）
  │     - user.py（用户模型）
  │
  ├→ 操作手册包含:
  │     - 4.2.1 用户登录
  │     - 描述："用户输入用户名和密码，点击登录按钮..."
  │     - 截图：login.png（HTML页面截取，表单字段与代码一致）
  │     - 操作步骤说明
  │
  └→ 申请表包含:
        - 主要功能描述中包含"用户登录"
        - 源程序量统计包含这些文件的行数
```

#### 8.1 一致性校验器

在步骤5生成文档前，运行一致性校验：

```python
class ConsistencyChecker:
    def check(self, context: ProjectContext) -> list[str]:
        warnings = []
        for feature in context.feature_list:
            # 检查1: 每个功能都有对应的代码文件
            if not feature.code_files:
                warnings.append(f"功能'{feature.name}'缺少对应代码")
            # 检查2: 需要截图的功能都有截图
            if feature.page_type and not feature.screenshot_path:
                warnings.append(f"功能'{feature.name}'缺少截图")
            # 检查3: HTML页面中的关键元素与代码中的字段名对应
        return warnings
```

## 后端API设计

### RESTful API 接口

```
POST   /api/generate                    # 提交生成任务
  请求体: {
    software_name: "xxx管理系统",
    description: "一个用于xxx的管理系统",
    project_type: "web",
    tech_stack: "springboot_vue",
    target_lines: 5000,
    completion_date: "2026-01-15"
  }
  响应: { task_id: "uuid-xxx" }

GET    /api/task/<task_id>              # 查询任务状态
  响应: {
    status: "processing" | "completed" | "failed",
    current_step: 3,
    step_name: "生成HTML页面",
    progress: 45,
    message: "正在生成用户登录页面..."
  }

GET    /api/task/<task_id>/stream       # SSE实时进度推送
  响应: text/event-stream

GET    /api/download/<task_id>/source       # 下载源码文档
GET    /api/download/<task_id>/manual       # 下载操作手册
GET    /api/download/<task_id>/application  # 下载申请表
GET    /api/download/<task_id>/all          # 下载ZIP包（3个文档）
```

### SSE进度推送

```python
# 后端SSE实现
@app.route('/api/task/<task_id>/stream')
def task_stream(task_id):
    def event_stream():
        while True:
            status = get_task_status(task_id)
            yield f"data: {json.dumps(status)}\n\n"
            if status['status'] in ('completed', 'failed'):
                break
            time.sleep(1)
    return Response(event_stream(), mimetype='text/event-stream')
```

```javascript
// 前端SSE接收（ProgressView.vue）
const eventSource = new EventSource(`/api/task/${taskId}/stream`)
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data)
  store.updateProgress(data)
}
```

## 项目结构

```
kinghy-bot/
├── server/                             # 后端（Flask）
│   ├── app.py                          # Flask主应用 + CORS配置
│   ├── config.py                       # 配置文件（API密钥、模型选择等）
│   ├── requirements.txt                # Python依赖
│   ├── .env.example                    # 环境变量示例
│   ├── api/                            # RESTful API路由
│   │   ├── __init__.py
│   │   ├── generate.py                 # 生成任务API
│   │   ├── task.py                     # 任务状态API + SSE
│   │   └── download.py                 # 文件下载API
│   ├── ai/                             # AI集成模块
│   │   ├── __init__.py
│   │   ├── ai_client.py               # AI API客户端（多模型适配）
│   │   ├── prompt_builder.py           # 提示词构建器
│   │   └── prompts/                    # 提示词模板目录
│   │       ├── feature_gen.txt         # 功能清单生成提示词
│   │       ├── code_gen.txt            # 代码生成提示词
│   │       ├── manual_gen.txt          # 操作手册内容提示词
│   │       └── page_gen.txt            # HTML页面生成提示词
│   ├── generators/                     # 生成器模块
│   │   ├── __init__.py
│   │   ├── orchestrator.py             # 生成编排器（核心协调）
│   │   ├── code_generator.py           # AI代码生成协调器
│   │   ├── code_validator.py           # 代码验证器
│   │   ├── code_expander.py            # 代码扩展器
│   │   ├── source_doc_generator.py     # 源码文档生成器
│   │   ├── manual_doc_generator.py     # 操作手册生成器
│   │   ├── application_doc_generator.py # 申请表生成器
│   │   ├── html_page_generator.py      # HTML页面生成器
│   │   ├── screenshot_service.py       # Playwright截图服务
│   │   └── consistency_checker.py      # 一致性校验器
│   ├── utils/                          # 工具函数
│   │   ├── __init__.py
│   │   ├── code_formatter.py           # 代码格式化
│   │   ├── line_counter.py             # 代码行数统计
│   │   ├── docx_helper.py             # Word文档辅助函数
│   │   └── file_manager.py            # 文件管理
│   ├── html_templates/                 # 截图用HTML页面模板
│   │   ├── base.html                   # 基础布局（侧边栏+顶栏+内容区）
│   │   ├── login.html                  # 登录页模板
│   │   ├── dashboard.html              # 仪表盘模板
│   │   ├── list.html                   # 列表页模板
│   │   ├── form.html                   # 表单页模板
│   │   ├── detail.html                 # 详情页模板
│   │   └── chart.html                  # 图表统计页模板
│   ├── template/                       # Word文档模板
│   │   ├── 申请表_模板.docx
│   │   ├── 操作手册_模板.docx
│   │   └── 代码文档_模板.docx
│   ├── output/                         # 生成的文档输出目录
│   │   └── .gitkeep
│   ├── screenshots/                    # 截图临时存储
│   │   └── .gitkeep
│   └── tests/                          # 测试文件
│       ├── test_ai_client.py
│       ├── test_generators.py
│       ├── test_screenshot.py
│       └── test_consistency.py
│
├── client/                             # 前端（Vue3 + Vite）
│   ├── package.json
│   ├── vite.config.js                  # Vite配置（含API代理）
│   ├── index.html
│   ├── src/
│   │   ├── main.js
│   │   ├── App.vue
│   │   ├── router/
│   │   │   └── index.js
│   │   ├── stores/
│   │   │   └── generate.js
│   │   ├── api/
│   │   │   └── index.js
│   │   ├── views/
│   │   │   ├── HomeView.vue
│   │   │   ├── ProgressView.vue
│   │   │   └── ResultView.vue
│   │   ├── components/
│   │   │   ├── ProjectForm.vue
│   │   │   ├── TechStackSelector.vue
│   │   │   ├── ProgressTracker.vue
│   │   │   ├── DocumentCard.vue
│   │   │   └── StepIndicator.vue
│   │   └── assets/
│   │       └── styles/
│   │           └── main.scss
│   └── public/
│       └── favicon.ico
│
├── docs/                               # 项目文档
│   ├── 设计文档_v1.0.md
│   └── 设计文档_v2.0.md
├── template/                           # 参考模板（只读）
│   ├── 基于SpringBoot的鱼缸控制系统_申请表.docx
│   ├── 基于SpringBoot的鱼缸控制系统_操作手册.docx
│   └── 基于SpringBoot的鱼缸控制系统_代码文档.docx
└── README.md
```

## 依赖清单

### 后端 Python 依赖 (requirements.txt)

```
flask>=3.0
flask-cors>=4.0
flask-restful>=0.3.10
celery>=5.3
redis>=5.0
python-docx>=1.1
Jinja2>=3.1
playwright>=1.40
Pygments>=2.17
python-dotenv>=1.0
requests>=2.31
```

### 前端 Node 依赖 (package.json)

```json
{
  "dependencies": {
    "vue": "^3.4",
    "vue-router": "^4.2",
    "pinia": "^2.1",
    "element-plus": "^2.5",
    "axios": "^1.6"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.0",
    "vite": "^5.0",
    "sass": "^1.69"
  }
}
```

## 开发与部署

### 本地开发

```bash
# 后端
cd server
pip install -r requirements.txt
playwright install chromium
cp .env.example .env  # 配置AI模型API密钥
flask run --port 5000

# Celery Worker
celery -A app.celery worker --loglevel=info

# Redis（需提前安装）
redis-server

# 前端
cd client
npm install
npm run dev  # 默认端口5173，Vite代理API到5000
```

### Vite API代理配置

```javascript
// vite.config.js
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true
      }
    }
  }
})
```

### 环境变量 (.env)

```
# AI模型配置（三选一）
AI_PROVIDER=zhipu              # zhipu / wenxin / tongyi
AI_API_KEY=your-api-key
AI_MODEL=glm-4

# Redis
REDIS_URL=redis://localhost:6379/0

# 文件存储
OUTPUT_DIR=./output
SCREENSHOT_DIR=./screenshots
```
